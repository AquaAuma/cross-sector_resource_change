---
title: "Check past shock frequency from ISIMIP models"
date: "`r format(Sys.time(), '%B, %Y')`"
fontsize: 20pt
output:
  html_document:
    toc: false
    toc_depth: '3'
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

rm(list = ls())

# load libraries
library(here)
library(tidyverse)
library(ggplot2)
library(gridExtra)
```

Supplementary analysis comparing shock frequency estimates from multiple sectors with [Cottrell et al., 2019 *Nature Sustainability*](https://www.nature.com/articles/s41893-018-0210-1).

Compared to that previous paper, we are not using observational data but simulated data from ISIMIP, covering 6 resources from three sectors (water, fisheries, maize, rice, soybean, wheat). The sectors are not the same, since in the Cottrell et al. paper there are also livestock and aquaculture in addition to fisheries and agriculture.

## Country shock frequency

### from 1983 until 2013

To compare our global shock frequency and Figure 1 from Cottrell et al., 2019 panels e and c, I calculated the proportion of countries experiencing a shock per sector per year per climate model.

Linear models are fitted to temporal trends per output variable and climate model.

```{r annual frequencies, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}
annual_freq <- read_csv("/Users/auroremaureaud/Library/CloudStorage/Dropbox/Minerva 2021 Climate Politics/Aurore/Resource synthesis/future_resource_change/data/short-term_change/countries_shocks_time_series_1985-2015.csv") %>% 
  filter(!output_variable %in% c("tws","tcb","ptotww"),
         experiment_climate == "ssp585") %>% 
  dplyr::select(-id, -percent_diff, -experiment_climate, -shock_up,
                -shock_down, -res, -spatial_scale, -sector) %>%
  group_by(regions, climate_model, years, output_variable) %>% 
  summarize(shock = round(mean(shock, na.rm=T),2)) %>% 
  ungroup() %>% 
  mutate(shock = ifelse(shock>0.5 & !is.na(shock), 1, shock),
         shock = ifelse(shock<0.5 & !is.na(shock), 0, shock),
         shock = ifelse(shock == 0.5 & !is.na(shock), 1, shock)) %>%
  group_by(climate_model, years, output_variable) %>% 
  summarize(shock = mean(shock, na.rm=T))

annual_freq %>% 
  filter(years<2014) %>% 
  ggplot(aes(x = years, y = shock, color = climate_model)) +
  geom_line() +
  facet_wrap(~ output_variable, scales = "free") +
  theme_bw() +
  ylab("Shock frequency") + xlab("Year") +
  geom_smooth(method=lm) +
  scale_color_manual(values = c("darksalmon", "firebrick2"))
```

### until the end of the century

From 1983 until 2100.

```{r long annual frequencies, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}
annual_freq <- read_csv("/Users/auroremaureaud/Library/CloudStorage/Dropbox/Minerva 2021 Climate Politics/Aurore/Resource synthesis/future_resource_change/data/short-term_change/countries_shocks_time_series_1985-2015.csv") %>% 
  filter(!output_variable %in% c("tws","tcb","ptotww"),
         experiment_climate == "ssp585") %>% 
  dplyr::select(-id, -percent_diff, -experiment_climate, -shock_up,
                -shock_down, -res, -spatial_scale, -sector) %>%
  group_by(regions, climate_model, years, output_variable) %>% 
  summarize(shock = round(mean(shock, na.rm=T),2)) %>% 
  ungroup() %>% 
  mutate(shock = ifelse(shock>0.5 & !is.na(shock), 1, shock),
         shock = ifelse(shock<0.5 & !is.na(shock), 0, shock),
         shock = ifelse(shock == 0.5 & !is.na(shock), 1, shock)) %>%
  group_by(climate_model, years, output_variable) %>% 
  summarize(shock = mean(shock, na.rm=T))

annual_freq %>% 
  ggplot(aes(x = years, y = shock, color = climate_model)) +
  geom_line() +
  facet_wrap(~ output_variable, scales = "free") +
  theme_bw() +
  ylab("Shock frequency") + xlab("Year") +
  geom_smooth(method=lm) +
  scale_color_manual(values = c("darksalmon", "firebrick2"))
```

## Cross-sector temporal trends

To compare Figure 4 from the Cottrell et al., paper, I plotted the temporal trends in resource production for Afghanistan, Dominica, Ecuador, and Kuwait. Black vertical lines indicate the main events that are identified as co-occurring with resource shocks for the specific cases. Sometimes, the same sectors are not plotted in our figure because the resources as not modelled for that specific country. For instance, there are no crops trends for Dominica, because main agricultural products there are not the 4 main crops modelled by ISIMIP.

```{r country plot, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}
pct_diff_ts_r_cs_ag <- read_csv("/Users/auroremaureaud/Library/CloudStorage/Dropbox/Minerva 2021 Climate Politics/Aurore/Resource synthesis/future_resource_change/data/data_processing/countries_time_series_1985-2015_2070-2099_agriculture.csv")
pct_diff_ts_r_cs_fi <- read_csv("/Users/auroremaureaud/Library/CloudStorage/Dropbox/Minerva 2021 Climate Politics/Aurore/Resource synthesis/future_resource_change/data/data_processing/countries_time-series_1985-2015_2070-2099_marine-fishery_global.csv")
pct_diff_ts_r_cs_wa <- read_csv("/Users/auroremaureaud/Library/CloudStorage/Dropbox/Minerva 2021 Climate Politics/Aurore/Resource synthesis/future_resource_change/data/data_processing/countries_time_series_1985-2015_2070-2099_water_global.csv")
pct_diff_ts_r_cs <- rbind(pct_diff_ts_r_cs_ag, pct_diff_ts_r_cs_fi, pct_diff_ts_r_cs_wa)
rm(pct_diff_ts_r_cs_ag, pct_diff_ts_r_cs_fi, pct_diff_ts_r_cs_wa)

pct_diff_ts_r_cs %>% 
  filter(!output_variable %in% c("tws","tcb","ptotww","qtot"),
         regions %in% c("Kuwait","Afghanistan","Dominica","Ecuador"),
         experiment_climate == "ssp585",
         years < 2014) %>% 
  group_by(years, climate_model, output_variable, regions) %>% 
  summarize(percent_diff = median(percent_diff, na.rm=T)) %>% 
  ggplot(aes(x = years, y = percent_diff)) + 
  geom_line(aes(color = output_variable, linetype = climate_model)) +
  facet_wrap(~regions, scale = "free") +
  theme_bw() +
  ylab("% Difference") + xlab("Year") +
  geom_vline(data = pct_diff_ts_r_cs %>% filter(regions == "Afghanistan"),aes(xintercept = 2000)) +
  geom_vline(data = pct_diff_ts_r_cs %>% filter(regions == "Kuwait"),aes(xintercept = 1990)) +
  geom_vline(data = pct_diff_ts_r_cs %>% filter(regions == "Dominica"),aes(xintercept = 1983)) +
  geom_vline(data = pct_diff_ts_r_cs %>% filter(regions == "Ecuador"),aes(xintercept = 1998)) +
  geom_vline(data = pct_diff_ts_r_cs %>% filter(regions == "Ecuador"),aes(xintercept = 2000))


```

## Cross-sector heat map

To compare Figure 3 panel b with our estimates for the same list of countries and the two climate models, we calculated the number of resources for which a shock is identified by 5-year bins. Although the resources are not the same, we could expect similar cross-sector shock hotspots.

```{r cs hear map, echo = FALSE, warning=FALSE, message=FALSE}
annual_freq <- read_csv("/Users/auroremaureaud/Library/CloudStorage/Dropbox/Minerva 2021 Climate Politics/Aurore/Resource synthesis/future_resource_change/data/short-term_change/countries_shocks_time_series_1985-2015.csv") %>% 
  filter(!output_variable %in% c("tws","tcb","ptotww"),
         regions %in% c("Philippines","North Korea","Pakistan","Maldives","Afghanistan",
                        "Kuwait","Iraq","Somalia","Madagascar","Burundi","Democratic Republic of the Congo",
                        "Nigeria","Mali","Liberia","Hungary","Albania","Austria","Venezuela","Ecuador",
                        "Saint Vincent and the Grenadines","Grenada","Barbados"),
         experiment_climate == "ssp585",
         years<2014) %>% 
  dplyr::select(-id, -percent_diff, -experiment_climate, -shock_up,
                -shock_down, -res, -spatial_scale, -sector) %>%
  group_by(regions, climate_model, years, output_variable) %>% 
  summarize(shock = round(mean(shock, na.rm=T),2)) %>% 
  ungroup() %>% 
  mutate(shock = ifelse(shock>0.5 & !is.na(shock), 1, shock),
         shock = ifelse(shock<0.5 & !is.na(shock), 0, shock),
         shock = ifelse(shock == 0.5 & !is.na(shock), 1, shock),
         group_years = case_when(years<1988 ~ "1983-87",
                                 years>1987 & years<1993 ~ "1988-92",
                                 years>1992 & years<1998 ~ "1993-97",
                                 years>1997 & years<2003 ~ "1998-2002",
                                 years>2002 & years<2008 ~ "2003-2007",
                                 years>2007 & years<2014 ~ "2008-2013")) %>%
  group_by(regions, climate_model, group_years) %>% 
  summarize(cs_shock = sum(shock, na.rm=T)) 

annual_freq %>% 
  filter(cs_shock>0) %>% 
  ggplot(aes(x = group_years, y = regions, fill = cs_shock)) +
  geom_tile() +
  theme_bw() +
  scale_fill_gradient2(low = "lightgoldenrodyellow", high = "red") +
  facet_wrap(~ climate_model) +
  scale_y_discrete(limits = c("Barbados","Grenada","Saint Vincent and the Grenadines",
                              "Ecuador","Venezuela","Austria","Albania","Hungary","Liberia",
                              "Mali","Nigeria","Democratic Republic of the Congo",
                              "Burundi","Madagascar","Somalia","Iraq","Kuwait",
                              "Afghanistan","Maldives","Pakistan","North Korea","Philippines"))+
  theme(axis.text.x = element_text(angle = -45, hjust = 0))
```
